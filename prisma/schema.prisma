generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Phase 7.3: Multi-Tenant - Organization
// ============================================

model Organization {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String?
  
  // Contact Information
  email       String?
  phone       String?
  
  // Configuration
  isActive    Boolean  @default(true)
  tier        String   @default("standard") // e.g., "free", "standard", "enterprise"
  
  // Monday.com Integration
  mondayWorkspaceId String? // Monday.com workspace/account ID
  
  // Billing (for future use)
  stripeCustomerId String?
  subscriptionStatus String? // "active", "trial", "canceled", "past_due"
  trialEndsAt      DateTime?
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?  // User ID who created this org
  
  // Settings (JSON for flexibility)
  settings    String   @default("{}") // JSON: custom org-level settings
  
  // Relations (reverse)
  users                      User[]
  internalSchemaVersions     InternalSchemaVersion[]
  fieldMappingConfigVersions FieldMappingConfigVersion[]
  auditLogs                  AuditLog[]
  ruleSetVersions            RuleSetVersion[]
  routingStates              RoutingState[]
  routingSettings            RoutingSettings[]
  routingProposals           RoutingProposal[]
  routingApplies             RoutingApply[]
  mondayUserCaches           MondayUserCache[]
  mondayBoardCaches          MondayBoardCache[]
  mondayCredentials          MondayCredential[]
  industryWatchStates        IndustryWatchState[]
  metricsConfigs             MetricsConfig[]
  leadFacts                  LeadFact[]
  agentMetricsSnapshots      AgentMetricsSnapshot[]
  agentProfiles              AgentProfile[]
  agentAvailabilities        AgentAvailability[]
  capacitySettings           CapacitySettings[]
  mondayWebhooks             MondayWebhook[]
  
  @@index([isActive])
  @@index([createdAt])
  @@index([mondayWorkspaceId])
}

// Phase 1 persistence model (minimal, Cursor-friendly).
// NOTE: SQLite connector does not support Prisma Json/enums in this setup.
// All JSON payloads are stored as STRING containing JSON text.
// Enum-like fields are stored as STRING with constrained values at the app layer.
model InternalSchemaVersion {
  id        String   @id @default(cuid())
  orgId     String
  version   Int
  payload   String // JSON string
  createdAt DateTime @default(now())
  createdBy String?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, version])
  @@index([orgId])
}

model FieldMappingConfigVersion {
  id        String   @id @default(cuid())
  orgId     String
  version   Int
  payload   String // JSON string
  createdAt DateTime @default(now())
  createdBy String?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, version])
  @@index([orgId])
}

model AuditLog {
  id          String   @id @default(cuid())
  orgId       String
  actorUserId String?
  action      String
  entityType  String
  entityId    String?
  before      String? // JSON string
  after       String? // JSON string
  createdAt   DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, createdAt])
  @@index([orgId, actorUserId, createdAt]) // Track user activities
  @@index([orgId, entityType, entityId]) // Fast entity lookups
  @@index([orgId, action, createdAt]) // Filter by action type
}

model RuleSetVersion {
  id        String   @id @default(cuid())
  orgId     String
  version   Int
  payload   String // JSON string
  createdAt DateTime @default(now())
  createdBy String?

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, version])
  @@index([orgId])
}

model RoutingState {
  id             String    @id @default(cuid())
  orgId          String    @unique
  isEnabled      Boolean   @default(false)
  enabledAt      DateTime?
  enabledBy      String?
  // snapshots of versions at time of enable
  schemaVersion  Int?
  mappingVersion Int?
  rulesVersion   Int?
  updatedAt      DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model RoutingSettings {
  id        String   @id @default(cuid())
  orgId     String   @unique
  // enum-like: "AUTO" | "MANUAL_APPROVAL"
  mode      String   @default("MANUAL_APPROVAL")
  // Phase 2: Daily lead threshold for availability calculation
  dailyLeadThreshold Int @default(20)
  // KPI Weights (0-100 for each metric) - JSON string
  kpiWeights String? // JSON: { workload, conversionHistorical, recentPerformance, responseTime, avgTimeToClose, avgDealSize, industryMatch, hotStreak }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model RoutingProposal {
  id             String @id @default(cuid())
  orgId          String
  idempotencyKey String
  boardId        String
  itemId         String
  itemName       String? // Name of the lead/item from Monday.com
  // enum-like: "PROPOSED" | "APPROVED" | "REJECTED" | "OVERRIDDEN" | "APPLIED"
  status         String @default("PROPOSED")

  // snapshots (JSON strings)
  normalizedValues String
  selectedRule     String?
  action           String? // RuleAction snapshot (JSON string)
  explainability   String? // JSON string

  // decision
  decidedAt     DateTime?
  decidedBy     String?
  decisionNotes String?

  // data updates (for re-scoring tracking)
  dataUpdatedAt DateTime? // Last time lead data was updated and proposal re-scored
  dataChanges   String?   // JSON string of changes that triggered re-scoring

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, idempotencyKey])
  @@index([orgId, status, createdAt])
  @@index([orgId, boardId, itemId])
  @@index([orgId, decidedBy, decidedAt]) // Track manager decisions
  @@index([status, createdAt]) // Global status filtering (for admin dashboards)
}

model RoutingApply {
  id         String   @id @default(cuid())
  orgId      String
  proposalId String
  appliedAt  DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, proposalId])
  @@index([orgId, appliedAt])
}

model MondayUserCache {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  name      String
  email     String
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId, email])
  @@index([orgId, name])
}

model MondayBoardCache {
  id        String   @id @default(cuid())
  orgId     String
  boardId   String
  boardName String
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, boardId])
  @@index([orgId, boardName])
}

model MondayCredential {
  id        String   @id @default(cuid())
  orgId     String   @unique
  tokenEnc  String
  endpoint  String   @default("https://api.monday.com/v2")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model IndustryWatchState {
  id            String   @id @default(cuid())
  orgId         String
  boardId       String
  itemId        String
  lastIndustry  String?
  lastCheckedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, boardId, itemId])
  @@index([orgId, boardId])
}

model MetricsConfig {
  id    String @id @default(cuid())
  orgId String @unique

  // windows
  conversionWindowDays Int @default(30)
  avgDealWindowDays    Int @default(90)
  responseWindowDays   Int @default(30)

  // Phase 2: KPI Weights (must sum to 100%)
  weightDomainExpertise      Int @default(30)  // NEW
  weightAvailability         Int @default(5)   // NEW
  weightConversionHistorical Int @default(20)  // Renamed from weightConversion
  weightRecentPerformance    Int @default(20)  // NEW (30-day conversion)
  weightAvgDealSize          Int @default(5)   // Renamed from weightAvgDeal
  weightResponseTime         Int @default(5)   // Renamed from weightResponseSpeed
  weightAvgTimeToClose       Int @default(5)   // NEW
  weightHotAgent             Int @default(10)  // Renamed from weightHotStreak

  // Phase 2: Hot Agent Configuration (user-configurable)
  hotAgentMinDeals     Int @default(3)   // NEW: min deals to be "hot"
  hotAgentWindowDays   Int @default(7)   // NEW: time window for hot calculation (converted from hours)

  // Phase 2: Recent Performance window (user-configurable)
  recentPerfWindowDays Int @default(30)  // NEW

  // Phase 2: Daily Lead Threshold (from previous update)
  dailyLeadThreshold Int @default(20)

  // DEPRECATED - kept for migration compatibility, will be removed in future
  hotStreakWindowHours      Int @default(72)
  hotStreakMinDeals         Int @default(1)
  burnoutWinDecayHours      Int @default(336)
  burnoutActivityDecayHours Int @default(168)
  weightIndustryPerf        Int @default(25)
  weightConversion          Int @default(20)
  weightAvgDeal             Int @default(15)
  weightHotStreak           Int @default(10)
  weightResponseSpeed       Int @default(15)
  weightBurnout             Int @default(10)
  weightAvailabilityCap     Int @default(5)

  // mappings (column ids + values)
  leadBoardIds   String // comma separated
  intakeColumnId String?
  intakeValue    String?

  contactedStatusColumnId String?
  contactedStatusValue    String?

  nextCallDateColumnId String?

  closedWonStatusColumnId String?
  closedWonStatusValue    String?

  dealAmountColumnId String?
  industryColumnId   String?

  // feature toggles
  enableIndustryPerf    Boolean @default(true)
  enableConversion      Boolean @default(true)
  enableAvgDealSize     Boolean @default(true)
  enableHotStreak       Boolean @default(true)
  enableResponseSpeed   Boolean @default(true)
  enableBurnout         Boolean @default(true)
  enableAvailabilityCap Boolean @default(true)

  // assignment mapping
  assignedPeopleColumnId String?

  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model LeadFact {
  id      String @id @default(cuid())
  orgId   String
  boardId String
  itemId  String
  itemName String? // Name of the lead/item from Monday.com

  // Monday values (last seen)
  assignedUserId String?
  industry       String?
  dealAmount     Float?
  statusValue    String?
  nextCallDate   String? // ISO date string (as text for simplicity)

  // derived timestamps
  enteredAt      DateTime? // when item was first seen in intake scope
  firstTouchAt   DateTime? // min(contactedStatusChange, nextCallDateSet)
  lastActivityAt DateTime? // last seen activity signal (status/date change)
  closedWonAt    DateTime? // when status became closedWon

  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, boardId, itemId])
  @@index([orgId, boardId])
  @@index([orgId, assignedUserId])
  // Performance optimization: indexes for timestamp-based queries
  @@index([orgId, closedWonAt])
  @@index([orgId, enteredAt])
  @@index([orgId, firstTouchAt])
  @@index([orgId, assignedUserId, enteredAt])
  @@index([orgId, assignedUserId, closedWonAt])
}

model AgentMetricsSnapshot {
  id          String   @id @default(cuid())
  orgId       String
  agentUserId String
  windowDays  Int
  computedAt  DateTime @default(now())

  assignedCount  Int   @default(0)
  closedWonCount Int   @default(0)
  conversionRate Float @default(0) // 0..1

  avgDealSize    Float @default(0)
  dealsAmountSum Float @default(0)

  medianResponseMinutes Int @default(0)

  hotDealsCount Int     @default(0)
  isHot         Boolean @default(false)

  hoursSinceLastWin      Int @default(999999)
  hoursSinceLastActivity Int @default(999999)

  burnoutScore Float @default(0) // 0..1 (higher is better)

  industryPerfJson String @default("{}") // json string

  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, agentUserId, windowDays])
  @@index([orgId, agentUserId])
  // Performance optimization: composite index for efficient lookups
  @@index([orgId, agentUserId, windowDays])
  @@index([orgId, windowDays])
}

// ============================================
// Phase 1: Agent Profiling
// ============================================

model AgentProfile {
  id                    String   @id @default(cuid())
  orgId                 String
  agentUserId           String
  agentName             String?
  
  // Performance Metrics
  conversionRate        Float?   // 0-1 scale
  totalLeadsHandled     Int      @default(0)
  totalLeadsConverted   Int      @default(0)
  
  // Revenue Metrics
  avgDealSize           Float?
  totalRevenue          Float    @default(0)
  
  // Speed Metrics
  avgResponseTime       Float?   // Seconds
  avgTimeToClose        Float?   // Seconds
  
  // Capacity Metrics
  availability          Float    @default(1)    // 0-1 scale
  currentActiveLeads    Int      @default(0)
  dailyLeadsToday       Int      @default(0)
  
  // Momentum Metrics
  hotStreakCount        Int      @default(0)
  hotStreakActive       Boolean  @default(false)
  
  // Burnout Indicators
  burnoutScore          Float    @default(0)    // 0-100
  timeSinceLastWin      BigInt?  // Milliseconds
  timeSinceLastActivity BigInt?  // Milliseconds
  
  // Domain Expertise (JSON)
  industryScores        String   @default("{}")  // JSON: { "SaaS": 85, "Retail": 52 }
  
  // Metadata
  computedAt            DateTime @default(now())
  dataWindowDays        Int      @default(90)
  updatedAt             DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  @@unique([orgId, agentUserId])
  @@index([orgId])
  @@index([orgId, agentUserId])
  @@index([orgId, availability])
  @@index([orgId, computedAt])
  @@index([orgId, conversionRate]) // Sort by performance
  @@index([orgId, hotStreakActive, availability]) // Find hot available agents
  @@index([orgId, burnoutScore]) // Monitor burnout levels
}

// ============================================
// Agent Availability & Capacity Management
// ============================================

model AgentAvailability {
  id          String   @id @default(cuid())
  orgId       String
  agentUserId String   // Monday.com user ID
  
  // Availability Status
  isAvailable Boolean  @default(true)  // Toggle: available/not available
  reason      String?  // Optional reason for exclusion (e.g., "On vacation")
  
  // Status changed by
  updatedBy   String?  // Admin user ID who made the change
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  @@unique([orgId, agentUserId])
  @@index([orgId])
  @@index([orgId, isAvailable])
}

model CapacitySettings {
  id     String @id @default(cuid())
  orgId  String @unique
  
  // Global capacity limits (applies to all agents)
  dailyLimit   Int? // Max leads per day (null = unlimited)
  weeklyLimit  Int? // Max leads per week (null = unlimited)
  monthlyLimit Int? // Max leads per month (null = unlimited)
  
  updatedBy String?  // Admin user ID
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  
  @@index([orgId])
}

// ============================================
// Phase 5.1: Authentication & Authorization
// ============================================

model User {
  id           String   @id @default(cuid())
  orgId        String?  // Nullable for super_admin users
  username     String
  email        String   @unique // Global unique for super_admin login
  passwordHash String
  // role: 'super_admin' | 'admin' | 'manager' | 'agent'
  role         String   @default("agent")
  firstName    String?
  lastName     String?
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Cascade)
  sessions     Session[]

  @@unique([orgId, username])
  @@unique([orgId, email])
  @@index([orgId, role])
  @@index([orgId, isActive])
  @@index([orgId, role, isActive]) // Active users by role
  @@index([email]) // Global email lookup for login
  @@index([lastLoginAt]) // Track user activity
  @@index([role]) // For super_admin queries
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  refreshExpiresAt DateTime?
  ipAddress    String?
  userAgent    String?
  isRevoked    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([refreshToken])
  @@index([expiresAt])
  @@index([userId, isRevoked, expiresAt]) // Active sessions by user
  @@index([isRevoked, expiresAt]) // Cleanup expired/revoked sessions
}

// Phase 2: Real-time Integration - Monday.com Webhooks
model MondayWebhook {
  id        String   @id @default(cuid())
  orgId     String
  boardId   String
  webhookId String   // Monday.com webhook ID
  url       String
  event     String   // e.g., "create_pulse", "change_column_value"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, boardId, event])
  @@index([orgId])
  @@index([boardId])
  @@index([isActive])
}
